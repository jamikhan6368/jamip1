<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runway Pro Admin</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 40px; max-width: 1000px; margin: 0 auto; }
        #login-screen { display: flex; height: 80vh; align-items: center; justify-content: center; flex-direction: column; }
        #dashboard { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .stat-num { font-size: 32px; font-weight: 800; color: var(--accent); }
        .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #334155; align-items: center; }
        input, select { background: #020617; border: 1px solid #475569; color: white; padding: 12px; border-radius: 6px; outline: none; font-family: inherit; }
        button { background: var(--accent); color: #0f172a; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        table { width: 100%; border-collapse: collapse; background: var(--panel); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        th { text-align: left; padding: 15px; background: #334155; font-size: 12px; color: #cbd5e1; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #334155; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .active { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .expired { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .btn-approve { background: #22c55e; color: #0f172a; padding: 6px 12px; margin-right: 5px; font-size: 11px; }
        .btn-del { background: transparent; color: var(--danger); padding: 6px 12px; border: 1px solid var(--danger); font-size: 11px; }
        .btn-del:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="margin-bottom: 20px;">ðŸ”’ Runway Pro Admin</h1>
        <div id="g_id_onload"
             data-client_id="1078904057208-6n2dp6ue13kiip5o0ir7480492ouk5rc.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-theme="filled_black"></div>
    </div>

    <div id="dashboard">
        <div class="header">
            <h2>Admin Dashboard</h2>
            <button onclick="location.reload()" style="background:#334155; color:white;">Log Out</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-num" id="total-users">0</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-num" id="active-users">0</div><div class="stat-label">Active Paid</div></div>
            <div class="stat-card"><div class="stat-num" id="pending-users">0</div><div class="stat-label">Pending Approval</div></div>
        </div>

        <div class="action-bar">
            <select id="new-type"><option value="email">Authorize Email</option><option value="key">Generate Key</option></select>
            <input id="new-value" placeholder="Enter Email or Key..." style="flex:1;">
            <select id="new-days"><option value="30">30 Days</option><option value="90">3 Months</option><option value="365">1 Year</option></select>
            <button onclick="createLicense()">+ Add User</button>
        </div>

        <table>
            <thead><tr><th>ID</th><th>User / Key</th><th>Type</th><th>Device Lock</th><th>Status</th><th>Expires</th><th>Actions</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        let TOKEN = null;

        function handleCredentialResponse(response) {
            TOKEN = response.credential;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            fetchData();
        }

        async function fetchData() {
            try {
                const res = await fetch('/api/admin', { headers: { 'Authorization': `Bearer ${TOKEN}` } });
                if(!res.ok) { const err = await res.json(); alert(err.error || "Admin Access Denied"); location.reload(); return; }
                const data = await res.json();
                renderTable(data);
            } catch(e) { alert("Connection Error"); }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            let active = 0, pending = 0;
            data.forEach(row => {
                if(row.is_active) active++;
                if(!row.is_active && row.transaction_id) pending++;
                const isExpired = new Date(row.expires_at) < new Date();
                let statusHTML = !row.is_active ? `<span class="badge pending">Pending</span>` : (isExpired ? `<span class="badge expired">Expired</span>` : `<span class="badge active">Active</span>`);
                let actionHTML = !row.is_active ? `<button class="btn-approve" onclick="approveUser(${row.key_id})">âœ” Approve</button>` : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>#${row.key_id}</td><td><div style="color:white; font-weight:600;">${row.email || row.license_key}</div>${row.transaction_id ? `<div style="font-size:10px; color:#94a3b8;">TRX: ${row.transaction_id}</div>` : ''}</td><td>${row.email ? 'ðŸ“§' : 'ðŸ”‘'}</td><td>${row.device_id ? 'ðŸ”’ Yes' : '<span style="opacity:0.5">No</span>'}</td><td>${statusHTML}</td><td>${new Date(row.expires_at).toLocaleDateString()}</td><td>${actionHTML}<button class="btn-del" onclick="deleteUser(${row.key_id})">Delete</button></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('total-users').innerText = data.length;
            document.getElementById('active-users').innerText = active;
            document.getElementById('pending-users').innerText = pending;
        }

        async function createLicense() {
            const type = document.getElementById('new-type').value;
            const value = document.getElementById('new-value').value;
            const days = document.getElementById('new-days').value;
            if(!value) return alert("Please enter a value");
            await fetch('/api/admin', { method: 'POST', headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ type, value, days }) });
            document.getElementById('new-value').value = '';
            fetchData();
        }

        async function approveUser(id) {
            if(!confirm("Confirm payment received?")) return;
            await fetch('/api/admin', { method: 'PUT', headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ id, action: 'approve' }) });
            fetchData();
        }

        async function deleteUser(id) {
            if(!confirm("Delete permanently?")) return;
            await fetch(`/api/admin?id=${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${TOKEN}` } });
            fetchData();
        }
    </script>
</body>
</html>
